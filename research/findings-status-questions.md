# Findings: STATUS.md and user-questions.json

## Overview

This document explains how agent questions are surfaced to the user-level Claude through the STATUS.md and user-questions.json mechanism, and identifies potential visibility issues.

---

## How STATUS.md Works

### Generation

STATUS.md is generated by the `update_claude_status()` function (ib:1696-1709). It creates a file at `.ittybitty/STATUS.md` containing:

```
<ittybitty-status>
[Agent status block from generate_status_block()]
[Questions block from generate_questions_block()]
</ittybitty-status>
```

### When It's Updated

`update_claude_status()` is called during these lifecycle events:
- **Agent creation** (`cmd_new_agent`) - line 3887
- **Agent kill** (`cmd_kill`) - line 4580
- **Agent merge** (`cmd_merge`) - line 4844
- **State changes** (via watchdog) - line 8029
- **Question asked** (`cmd_ask`) - line 7642
- **Question acknowledged** (`cmd_acknowledge`) - line 7731

### How User-Level Claude Sees It

The connection happens via an `@import` directive in CLAUDE.md (line 751):

```markdown
@.ittybitty/STATUS.md
```

This `@import` is placed inside the `<ittybitty>...</ittybitty>` block. When Claude Code reads CLAUDE.md at conversation start, it imports the contents of STATUS.md inline.

---

## How user-questions.json Works

### Structure

Questions are stored in `.ittybitty/user-questions.json` with this format:

```json
{
  "questions": [
    {
      "id": "q-1704825600-abc123",
      "agent": "agent-id",
      "question": "Should I proceed with option A or B?",
      "timestamp": "2026-01-10T15:00:00Z",
      "status": "pending"
    }
  ]
}
```

### Question Lifecycle

1. **Creation**: Agent calls `ib ask "question"` (cmd_ask, line 7590+)
   - Generates unique question ID (timestamp + hash)
   - Appends question to user-questions.json with status "pending"
   - Calls `update_claude_status()` to refresh STATUS.md
   - Agent enters WAITING state

2. **Acknowledgment**: User-level Claude calls `ib acknowledge <question-id>` (cmd_acknowledge, line 7652+)
   - Updates question status to "acknowledged"
   - Adds acknowledged_at timestamp
   - Calls `update_claude_status()` to refresh STATUS.md

3. **Response**: User-level Claude calls `ib send <agent-id> "answer"`
   - Message delivered to agent via tmux stdin
   - Agent resumes work

### Surfacing to User-Level Claude

The `generate_questions_block()` function (ib:1666-1691) formats pending questions for STATUS.md:

```markdown
## Pending Questions (1)

Agents are waiting for your response. Use 'ib acknowledge <id>' then 'ib send <agent> "answer"' to respond.

- **q-1704825600-abc123** from my-agent (2026-01-10T15:00:00Z):
  "Should I proceed with option A or B?"
```

---

## Question Flow Summary

```
Agent                    File System                User-Level Claude
  |                          |                           |
  | ib ask "question"        |                           |
  |------------------------->| user-questions.json       |
  |                          | updated                   |
  |                          |-------------------------->| (next CLAUDE.md read)
  |                          | STATUS.md updated         | sees @import
  |                          |                           |
  | (enters WAITING)         |                           | ib acknowledge <id>
  |                          |<--------------------------|
  |                          | status="acknowledged"     |
  |                          |                           |
  |<-------------------------|                           | ib send <agent> "answer"
  | (receives answer         |                           |
  |  via tmux stdin)         |                           |
```

---

## Potential Visibility Issues

### 1. No Mid-Conversation Updates (PRIMARY ISSUE)

**Problem**: Claude Code reads CLAUDE.md (and imports STATUS.md) at conversation start, not continuously. If an agent asks a question after the conversation has begun, the user-level Claude won't see it until:
- The user starts a new conversation
- The user explicitly asks Claude to check for questions

**Evidence**: The @import mechanism is a static file inclusion, not a live subscription. CLAUDE.md is processed when Claude Code initializes, and the context is frozen.

### 2. User Must Know to Check

**Problem**: Even with STATUS.md properly updated, the user needs to:
- Run `ib watch` in a terminal to monitor agents, OR
- Periodically ask Claude to check `ib questions`, OR
- Start a new conversation

**Missing**: There's no notification system that interrupts the user-level Claude conversation when a question arrives.

### 3. Setup Dependency

**Problem**: The entire mechanism requires:
- `<ittybitty>` block installed in CLAUDE.md
- `@.ittybitty/STATUS.md` import added inside that block

If these aren't set up (via `ib setup` or the `ib watch` dialog), questions will never be visible to Claude.

**Detection**: The `cmd_ask` function warns if CLAUDE.md doesn't have the import (lines 2598-2612):
```
Warning: CLAUDE.md does not import .ittybitty/STATUS.md
The 'ib ask' feature requires CLAUDE.md to import .ittybitty/STATUS.md
```

### 4. Timing Window

**Problem**: There's a race condition window between:
- Agent asking question (STATUS.md updated)
- User-level Claude's next opportunity to see it

If the user-level Claude is actively generating a response when the question arrives, it won't see the update until its next turn.

### 5. File-Based Communication Limitation

**Problem**: The mechanism relies on file-based communication:
- Agent writes to user-questions.json
- STATUS.md is regenerated
- Claude reads STATUS.md via @import

This is inherently "pull" rather than "push" - the user-level Claude must actively read the file, it won't be notified of changes.

---

## Recommendations (for future consideration)

1. **Add explicit instruction to check questions**: The ittybitty instructions in CLAUDE.md could include a reminder for Claude to periodically run `ib questions` when it has spawned agents.

2. **Watchdog notification for user-level Claude**: Currently watchdog only notifies manager agents. Could potentially extend to notify user-level Claude, though the mechanism would be different (can't use stdin).

3. **Terminal bell/notification**: When a question is asked, `ib ask` could trigger a terminal notification (bell, macOS notification) to alert the human user.

4. **Integration with Claude's pending messages**: If Claude Code ever supports a "pending messages" or "notification" mechanism, questions could be surfaced there.

---

## Files Examined

- `ib` script: lines 1666-1709 (STATUS.md generation), 7590-7736 (ask/acknowledge commands)
- `CLAUDE.md`: lines 610-753 (ittybitty block with @import)
